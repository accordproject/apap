{
  "$class": "org.accordproject.protocol@1.0.0.Template",
  "uri": "resource:org.accordproject.protocol@1.0.0.Template#latedeliveryandpenalty-typescript",
  "author": "Unknown",
  "displayName": "latedeliveryandpenalty-typescript",
  "version": "0.0.1",
  "description": "Late Delivery and Penalty. In case of delayed delivery except for Force Majeure cases, the Seller shall pay to the Buyer for every 9 DAY of delay penalty amounting to 7.0% of the total value of the Equipment whose delivery has been delayed. Any fractional part of a DAY is to be considered a full DAY. The total amount of penalty shall not however, exceed 2.0% of the total value of the Equipment involved in late delivery. If the delay is more than 2 WEEK, the Buyer is entitled to terminate this Contract.",
  "license": "Apache-2.0",
  "metadata": {
    "$class": "org.accordproject.protocol@1.0.0.TemplateMetadata",
    "runtime": "typescript",
    "template": "clause",
    "cicero": "^0.25.0"
  },
  "logo": null,
  "templateModel": {
    "$class": "org.accordproject.protocol@1.0.0.TemplateModel",
    "typeName": "io.clause.latedeliveryandpenalty@0.1.0.TemplateModel",
    "model": {
      "$class": "org.accordproject.protocol@1.0.0.CtoModel",
      "ctoFiles": [
        {
          "$class": "org.accordproject.protocol@1.0.0.CtoFile",
          "contents": "namespace io.clause.latedeliveryandpenalty@0.1.0\n\nimport org.accordproject.time@0.3.0.{Duration, TemporalUnit} from https://models.accordproject.org/time@0.3.0.cto\n\nimport org.accordproject.contract@0.2.0.Clause from https://models.accordproject.org/accordproject/contract@0.2.0.cto\nimport org.accordproject.runtime@0.2.0.{Request,Response} from https://models.accordproject.org/accordproject/runtime@0.2.0.cto\n\n/**\n * Defines the data model for the LateDeliveryAndPenalty template.\n * This defines the structure of the abstract syntax tree that the parser for the template\n * must generate from input source text.\n */\n@template\nasset TemplateModel extends Clause {\n  /**\n   * Does the clause include a force majeure provision?\n   */\n  o Boolean forceMajeure\n\n  /**\n   * For every penaltyDuration that the goods are late\n   */\n  o Duration penaltyDuration\n\n  /**\n   * Seller pays the buyer penaltyPercentage % of the value of the goods\n   */\n  o Double penaltyPercentage\n\n  /**\n   * Up to capPercentage % of the value of the goods\n   */\n  o Double capPercentage\n\n  /**\n   * If the goods are >= termination late then the buyer may terminate the contract\n   */\n  o Duration termination\n\n  /**\n   * Fractional part of a ... is considered a whole ...\n   */\n  o TemporalUnit fractionalPart\n}\n\n/**\n * Defines the input data required by the template\n */\ntransaction LateDeliveryAndPenaltyRequest extends Request {\n\n  /**\n   * Are we in a force majeure situation?\n   */\n  o Boolean forceMajeure\n\n  /**\n   * What was the agreed delivery date for the goods?\n   */\n  o DateTime agreedDelivery\n\n  /**\n   * If the goods have been delivered, when where they delivered?\n   */\n  o DateTime deliveredAt optional\n\n  /**\n   * What is the value of the goods?\n   */\n  o Double goodsValue\n}\n\n/**\n * Defines the output data for the template\n */\ntransaction LateDeliveryAndPenaltyResponse extends Response {\n  /**\n   * The penalty to be paid by the seller\n   */\n  o Double penalty\n\n  /**\n   * Whether the buyer may terminate the contract\n   */\n  o Boolean buyerMayTerminate\n}\n\n/**\n * Define an event that is emitted by the template\n */\nevent LateDeliveryAndPenaltyEvent {\n  o Boolean penaltyCalculated\n}\n\n/**\n * Defines the state of the template\n */\nconcept LateDeliveryAndPenaltyState identified {\n  o Integer count\n  o Boolean lateDeliveryProcessed default=false\n  o Double totalPenalties default=0.0\n}\n",
          "filename": "model.cto"
        },
        {
          "$class": "org.accordproject.protocol@1.0.0.CtoFile",
          "contents": "/*\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconcerto version \"^3.0.0\"\n\nnamespace org.accordproject.contract@0.2.0\n\n/**\n * Contract Data\n * -- Describes the structure of contracts and clauses\n */\n\n/* A contract is a asset -- This contains the contract data */\nabstract asset Contract identified by contractId {\n  o String contractId\n}\n\n/* A clause is an asset -- This contains the clause data */\nabstract asset Clause identified by clauseId {\n  o String clauseId\n}\n",
          "filename": "@models.accordproject.org.accordproject.contract@0.2.0.cto"
        },
        {
          "$class": "org.accordproject.protocol@1.0.0.CtoFile",
          "contents": "/*\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconcerto version \"^3.0.0\"\n\nnamespace org.accordproject.runtime@0.2.0\n\nimport org.accordproject.contract@0.2.0.Contract from https://models.accordproject.org/accordproject/contract@0.2.0.cto\n\n/**\n * Runtime API\n * -- Describes input and output of calls to a contract's clause\n */\n\n/* A request is a transaction */\ntransaction Request {\n}\n\n/* A response is a transaction */\ntransaction Response {\n}\n\n/* An event that represents an obligation that needs to be fulfilled */\nabstract event Obligation identified {\n  /* A back reference to the governing contract that emitted this obligation */\n  --> Contract contract\n\n  /* The party that is obligated */\n  --> Participant promisor optional\n\n  /* The party that receives the performance */\n  --> Participant promisee optional\n\n  /* The time before which the obligation is fulfilled */\n  o DateTime deadline optional\n}\n\n/* A contract state is an asset -- The runtime state of the contract */\nasset State {\n}\n",
          "filename": "@models.accordproject.org.accordproject.runtime@0.2.0.cto"
        },
        {
          "$class": "org.accordproject.protocol@1.0.0.CtoFile",
          "contents": "/*\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nconcerto version \"^3.0.0\"\n\nnamespace org.accordproject.time@0.3.0\n\n/**\n * Months of the year\n */\nenum Month {\n  o January\n  o February\n  o March\n  o April\n  o May\n  o June\n  o July\n  o August\n  o September\n  o October\n  o November\n  o December\n}\n\n/**\n * Days of the week\n */\nenum Day {\n  o Monday\n  o Tuesday\n  o Wednesday\n  o Thursday\n  o Friday\n  o Saturday\n  o Sunday\n}\n\n/**\n * Units for a duration.\n */\nenum TemporalUnit {\n  o seconds\n  o minutes\n  o hours\n  o days\n  o weeks\n}\n\n/**\n * A duration. For example, 6 hours.\n */\nconcept Duration {\n  o Long amount\n  o TemporalUnit unit\n}\n\n/**\n * Units for a time period.\n */\nenum PeriodUnit {\n  o days\n  o weeks\n  o months\n  o quarters\n  o years\n}\n\n/**\n * A time period. For example, 2 months.\n */\nconcept Period {\n  o Long amount\n  o PeriodUnit unit\n}\n",
          "filename": "@models.accordproject.org.time@0.3.0.cto"
        }
      ]
    }
  },
  "text": {
    "$class": "org.accordproject.protocol@1.0.0.Text",
    "templateText": "Late Delivery and Penalty\n----\nIn case of delayed delivery{{#if forceMajeure}} except for Force Majeure cases,{{/if}} the Seller shall pay to the Buyer for every {{penaltyDuration}} of delay penalty amounting to {{penaltyPercentage}}% of the total value of the Equipment whose delivery has been delayed.\n\n1. Any fractional part of a {{fractionalPart}} is to be considered a full {{fractionalPart}}.\n1. The total amount of penalty shall not however, exceed {{capPercentage}}% of the total value of the Equipment involved in late delivery.\n1. If the delay is more than {{termination}}, the Buyer is entitled to terminate this Contract.\n"
  },
  "logic": {
    "$class": "org.accordproject.protocol@1.0.0.Logic",
    "codes": [
      {
        "$class": "org.accordproject.protocol@1.0.0.Code",
        "id": "logic.test.ts",
        "type": "TYPESCRIPT",
        "encoding": "PLAIN_TEXT",
        "value": "// @ts-nocheck - Suppress type checking for runtime mocks\n// Mock the runtime imports before importing logic\ndeclare global {\n    var TemplateLogic: any;\n    var EngineResponse: any;\n    var InitResponse: any;\n}\n\n// Mock the runtime imports\n(global as any).TemplateLogic = class TemplateLogic<T, S> {\n    async init(data: T): Promise<any> { return { state: {} }; }\n    async trigger(data: T, request: any, state: S): Promise<any> { return {}; }\n} as any;\n\n(global as any).EngineResponse = class EngineResponse<S> {} as any;\n(global as any).InitResponse = class InitResponse<S> {} as any;\n\n// Now import after mocks are set up\nimport LateDeliveryLogic from './logic';\nimport { ITemplateModel, ILateDeliveryAndPenaltyRequest, ILateDeliveryAndPenaltyState, ILateDeliveryAndPenaltyResponse, ILateDeliveryAndPenaltyEvent } from './generated/io.clause.latedeliveryandpenalty@0.1.0';\n\ndescribe('LateDeliveryLogic', () => {\n    let logic: LateDeliveryLogic;\n    let mockTemplateModel: ITemplateModel;\n    let initialState: ILateDeliveryAndPenaltyState;\n\n    beforeEach(() => {\n        logic = new LateDeliveryLogic();\n        mockTemplateModel = {\n            forceMajeure: false,\n            penaltyDuration: {\n                $class: 'org.accordproject.time@0.3.0.Duration',\n                amount: 2,\n                unit: 'days' as any\n            },\n            penaltyPercentage: 10.5,\n            capPercentage: 55.0,\n            termination: {\n                $class: 'org.accordproject.time@0.3.0.Duration',\n                amount: 15,\n                unit: 'days' as any\n            },\n            fractionalPart: 'days' as any,\n            clauseId: 'test-clause-id',\n            $identifier: 'test-clause-id',\n            $class: 'io.clause.latedeliveryandpenalty@0.1.0.TemplateModel'\n        };\n\n        initialState = {\n            $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyState',\n            $identifier: 'test-clause-id',\n            count: 0,\n            lateDeliveryProcessed: false,\n            totalPenalties: 0.0\n        };\n    });\n\n    describe('init method', () => {\n        it('should initialize state with default values', async () => {\n            const result = await logic.init(mockTemplateModel);\n            \n            expect(result.state).toEqual({\n                $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyState',\n                $identifier: 'test-clause-id',\n                count: 0,\n                lateDeliveryProcessed: false,\n                totalPenalties: 0.0\n            });\n        });\n\n        it('should use the template model identifier', async () => {\n            mockTemplateModel.$identifier = 'custom-id-123';\n            const result = await logic.init(mockTemplateModel);\n            \n            expect((result.state as ILateDeliveryAndPenaltyState).$identifier).toBe('custom-id-123');\n        });\n    });\n\n    describe('trigger method', () => {\n        describe('Force Majeure scenarios', () => {\n            it('should return zero penalty only if both contract and request have force majeure', async () => {\n                // Only request.forceMajeure true\n                let request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: true,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-10'),\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                let result = await logic.trigger(mockTemplateModel, request, initialState);\n                \n                // Should calculate penalty as normal (force majeure not in contract)\n                const delayMs = new Date('2024-01-10').getTime() - new Date('2024-01-01').getTime();\n                const penaltyDurationMs = 2 * 24 * 60 * 60 * 1000;\n                const diffRatio = delayMs / penaltyDurationMs;\n                const penaltyRaw = diffRatio * 0.105 * 10000;\n                const maxPenalty = 0.55 * 10000;\n                const expectedPenalty = Math.min(penaltyRaw, maxPenalty);\n\n                expect(result.result.penalty).toBeCloseTo(expectedPenalty, 6);\n                expect(result.result.buyerMayTerminate).toBe(false);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(expectedPenalty, 6);\n\n                // Both contract and request force majeure\n                mockTemplateModel.forceMajeure = true;\n                result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                expect(result.result.penalty).toBe(0.0);\n                expect(result.result.buyerMayTerminate).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(false); // No penalty, so flag stays false\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBe(0.0);\n            });\n        });\n\n        describe('No delivery scenarios', () => {\n            it('should use now() if deliveredAt is not specified', async () => {\n                const agreed = new Date();\n                agreed.setDate(agreed.getDate() - 5); // 5 days ago\n\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: agreed,\n                    deliveredAt: undefined,\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                // Since we're using now(), we can't predict the exact penalty\n                // Just verify it's calculated and state is updated\n                expect(result.result.penalty).toBeGreaterThan(0);\n                expect(result.result.penalty).toBeLessThan(5500); // Should be less than cap\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeGreaterThan(0);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeLessThan(5500);\n            });\n        });\n\n        describe('On-time and early delivery scenarios', () => {\n            it('should return zero penalty when delivered on time', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-01'),\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                expect(result.result.penalty).toBe(0.0);\n                expect(result.result.buyerMayTerminate).toBe(false);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(false);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBe(0.0);\n            });\n\n            it('should throw if exercised before agreed delivery date', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2023-12-30'),\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                await expect(logic.trigger(mockTemplateModel, request, initialState))\n                    .rejects.toThrow('Cannot exercise late delivery before delivery date');\n            });\n        });\n\n        describe('Late delivery penalty calculations', () => {\n            it('should calculate penalty for 1 day late delivery (ratio-based)', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-02'), // 1 day late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                // 1 day / 2 days = 0.5\n                const expectedPenalty = 0.5 * 0.105 * 10000;\n                expect(result.result.penalty).toBeCloseTo(expectedPenalty, 6);\n                expect(result.result.buyerMayTerminate).toBe(false);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(expectedPenalty, 6);\n                expect(result.events).toHaveLength(1);\n                expect(result.events[0]).toHaveProperty('penaltyCalculated', true);\n            });\n\n            it('should calculate penalty for 2 days late delivery (ratio-based)', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-03'), // 2 days late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                // 2 days / 2 days = 1\n                const expectedPenalty = 1 * 0.105 * 10000;\n                expect(result.result.penalty).toBeCloseTo(expectedPenalty, 6);\n                expect(result.result.buyerMayTerminate).toBe(false);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(expectedPenalty, 6);\n            });\n\n            it('should calculate penalty for 4 days late delivery (ratio-based)', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-05'), // 4 days late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                // 4 days / 2 days = 2\n                const expectedPenalty = 2 * 0.105 * 10000;\n                expect(result.result.penalty).toBeCloseTo(expectedPenalty, 6);\n                expect(result.result.buyerMayTerminate).toBe(false);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(expectedPenalty, 6);\n            });\n\n            it('should allow fractional penalty (no rounding up)', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01T00:00:00'),\n                    deliveredAt: new Date('2024-01-02T12:00:00'), // 1.5 days late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                // 1.5 days / 2 days = 0.75\n                const expectedPenalty = 0.75 * 0.105 * 10000;\n                expect(result.result.penalty).toBeCloseTo(expectedPenalty, 6);\n                expect(result.result.buyerMayTerminate).toBe(false);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(expectedPenalty, 6);\n            });\n        });\n\n        describe('Penalty cap scenarios', () => {\n            it('should apply penalty cap when calculated penalty exceeds cap', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-20'), // 19 days late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                // 19 days / 2 days = 9.5, penaltyRaw = 9.5 * 0.105 * 10000 = 9975, capped at 5500\n                expect(result.result.penalty).toBeCloseTo(5500, 6);\n                expect(result.result.buyerMayTerminate).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(5500, 6);\n            });\n\n            it('should not apply cap when calculated penalty is below cap', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-10'), // 9 days late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                // 9 days / 2 days = 4.5, penaltyRaw = 4.5 * 0.105 * 10000 = 4725\n                expect(result.result.penalty).toBeCloseTo(4725, 6);\n                expect(result.result.buyerMayTerminate).toBe(false);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(4725, 6);\n            });\n        });\n\n        describe('Termination scenarios', () => {\n            it('should allow termination only if delay is strictly greater than threshold', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-17'), // 16 days late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                // Termination threshold is 15 days, so 16 > 15 triggers termination\n                expect(result.result.buyerMayTerminate).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n            });\n\n            it('should not allow termination if delay is equal to threshold', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-16'), // 15 days late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                expect(result.result.buyerMayTerminate).toBe(false);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n            });\n        });\n\n        describe('State management', () => {\n            it('should track lateDeliveryProcessed flag when penalty is calculated', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-03'), // 2 days late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).count).toBe(1);\n            });\n\n            it('should maintain lateDeliveryProcessed flag once set to true', async () => {\n                const stateWithFlag: ILateDeliveryAndPenaltyState = {\n                    ...initialState,\n                    lateDeliveryProcessed: true,\n                    count: 5\n                };\n\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-01'), // On time, no penalty\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, stateWithFlag);\n\n                // Flag should remain true even though this trigger has no penalty\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).count).toBe(6);\n            });\n\n            it('should accumulate totalPenalties across multiple triggers', async () => {\n                const request1: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-03'), // 2 days late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result1 = await logic.trigger(mockTemplateModel, request1, initialState);\n                const expectedPenalty1 = 1 * 0.105 * 10000;\n\n                expect((result1.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(expectedPenalty1, 6);\n                expect((result1.state as ILateDeliveryAndPenaltyState).count).toBe(1);\n\n                // Second trigger with different delay\n                const request2: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-10'),\n                    deliveredAt: new Date('2024-01-12'), // 2 days late again\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result2 = await logic.trigger(mockTemplateModel, request2, result1.state as ILateDeliveryAndPenaltyState);\n                const expectedPenalty2 = 1 * 0.105 * 10000;\n                const expectedTotal = expectedPenalty1 + expectedPenalty2;\n\n                expect((result2.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(expectedTotal, 6);\n                expect((result2.state as ILateDeliveryAndPenaltyState).count).toBe(2);\n                expect((result2.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n            });\n\n            it('should increment count on each trigger', async () => {\n                let currentState = initialState;\n\n                for (let i = 1; i <= 5; i++) {\n                    const request: ILateDeliveryAndPenaltyRequest = {\n                        forceMajeure: false,\n                        agreedDelivery: new Date('2024-01-01'),\n                        deliveredAt: new Date('2024-01-01'), // On time\n                        goodsValue: 10000,\n                        $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                        $timestamp: new Date()\n                    };\n\n                    const result = await logic.trigger(mockTemplateModel, request, currentState);\n                    expect((result.state as ILateDeliveryAndPenaltyState).count).toBe(i);\n                    currentState = result.state as ILateDeliveryAndPenaltyState;\n                }\n            });\n        });\n\n        describe('Different time units', () => {\n            it('should handle hours as penalty duration unit (ratio-based)', async () => {\n                mockTemplateModel.penaltyDuration = {\n                    $class: 'org.accordproject.time@0.3.0.Duration',\n                    amount: 24,\n                    unit: 'hours' as any\n                };\n\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01T00:00:00'),\n                    deliveredAt: new Date('2024-01-02T12:00:00'), // 36 hours late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                // 36/24 = 1.5\n                const expectedPenalty = 1.5 * 0.105 * 10000;\n                expect(result.result.penalty).toBeCloseTo(expectedPenalty, 6);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(expectedPenalty, 6);\n            });\n\n            it('should handle weeks as penalty duration unit (ratio-based)', async () => {\n                mockTemplateModel.penaltyDuration = {\n                    $class: 'org.accordproject.time@0.3.0.Duration',\n                    amount: 1,\n                    unit: 'weeks' as any\n                };\n\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-15'), // 14 days late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                // 14 days / 7 days = 2\n                const expectedPenalty = 2 * 0.105 * 10000;\n                expect(result.result.penalty).toBeCloseTo(expectedPenalty, 6);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(expectedPenalty, 6);\n            });\n        });\n\n        describe('Edge cases', () => {\n            it('should handle zero goods value', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-10'),\n                    goodsValue: 0,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                expect(result.result.penalty).toBe(0.0);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(false);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBe(0.0);\n            });\n\n            it('should handle very large goods value', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-02'),\n                    goodsValue: 1000000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                // 1 day / 2 days = 0.5\n                const expectedPenalty = 0.5 * 0.105 * 1000000;\n                expect(result.result.penalty).toBeCloseTo(expectedPenalty, 6);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(expectedPenalty, 6);\n            });\n\n            it('should handle very small delay (less than 1 penalty unit, ratio-based)', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01T00:00:00'),\n                    deliveredAt: new Date('2024-01-01T12:00:00'), // 0.5 days late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                // 0.5 days / 2 days = 0.25\n                const expectedPenalty = 0.25 * 0.105 * 10000;\n                expect(result.result.penalty).toBeCloseTo(expectedPenalty, 6);\n                expect((result.state as ILateDeliveryAndPenaltyState).lateDeliveryProcessed).toBe(true);\n                expect((result.state as ILateDeliveryAndPenaltyState).totalPenalties).toBeCloseTo(expectedPenalty, 6);\n            });\n        });\n\n        describe('Response structure', () => {\n            it('should return correct response structure', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-03'),\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                expect(result.result).toHaveProperty('penalty');\n                expect(result.result).toHaveProperty('buyerMayTerminate');\n                expect(result.result).toHaveProperty('$timestamp');\n                expect(result.result).toHaveProperty('$class');\n                expect(result.state).toHaveProperty('count');\n                expect(result.state).toHaveProperty('lateDeliveryProcessed');\n                expect(result.state).toHaveProperty('totalPenalties');\n                expect(result.events).toBeDefined();\n                expect(Array.isArray(result.events)).toBe(true);\n            });\n        });\n\n        describe('Events', () => {\n            it('should emit event with penaltyCalculated true when penalty > 0', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-03'), // 2 days late\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                expect(result.events).toHaveLength(1);\n                expect(result.events[0]).toHaveProperty('$class', 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyEvent');\n                expect(result.events[0]).toHaveProperty('penaltyCalculated', true);\n                expect(result.events[0]).toHaveProperty('$timestamp');\n            });\n\n            it('should emit event with penaltyCalculated false when penalty = 0', async () => {\n                const request: ILateDeliveryAndPenaltyRequest = {\n                    forceMajeure: false,\n                    agreedDelivery: new Date('2024-01-01'),\n                    deliveredAt: new Date('2024-01-01'), // On time\n                    goodsValue: 10000,\n                    $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest',\n                    $timestamp: new Date()\n                };\n\n                const result = await logic.trigger(mockTemplateModel, request, initialState);\n\n                expect(result.events).toHaveLength(1);\n                expect(result.events[0]).toHaveProperty('penaltyCalculated', false);\n            });\n        });\n    });\n});\n\n"
      },
      {
        "$class": "org.accordproject.protocol@1.0.0.Code",
        "id": "logic.ts",
        "type": "TYPESCRIPT",
        "encoding": "PLAIN_TEXT",
        "value": "// import { EngineResponse, TemplateLogic } from \"../../../../src/slc/SmartLegalContract\";\nimport { ILateDeliveryAndPenaltyState, ILateDeliveryAndPenaltyRequest, ILateDeliveryAndPenaltyResponse, ILateDeliveryAndPenaltyEvent, ITemplateModel } from \"./generated/io.clause.latedeliveryandpenalty@0.1.0\";\n\n// Inline types from org.accordproject.time@0.3.0 since generated files may not be available at runtime\n// These types are needed for duration conversion\nenum TemporalUnit {\n    seconds = 'seconds',\n    minutes = 'minutes',\n    hours = 'hours',\n    days = 'days',\n    weeks = 'weeks',\n}\n\ninterface IDuration {\n    amount: number;\n    unit: TemporalUnit;\n}\n\n// @ts-expect-error EngineResponse is imported by the runtime\ninterface LateDeliveryContractResponse extends EngineResponse<ILateDeliveryAndPenaltyState> {\n    result: ILateDeliveryAndPenaltyResponse;\n    state: object;\n    events: object[];\n}\n\n// @ts-ignore TemplateLogic is imported by the runtime\nclass LateDeliveryLogic extends TemplateLogic<ITemplateModel, ILateDeliveryAndPenaltyState>  {\n    // @ts-expect-error InitResponse is imported by the runtime\n    async init(data: ITemplateModel) : Promise<InitResponse<ILateDeliveryAndPenaltyState>> {\n        return {\n            state: {\n                $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyState',\n                $identifier: data.$identifier,\n                count: 0,\n                lateDeliveryProcessed: false,\n                totalPenalties: 0.0,\n            }\n        }\n    }\n\n    /**\n     * Convert Duration to milliseconds\n     * Manual conversion without requiring dayjs duration plugin\n     */\n    private convertDurationToMilliseconds(duration: IDuration): number {\n        const amount = duration.amount;\n        const unit = duration.unit;\n        \n        // Conversion factors to milliseconds\n        const MS_PER_SECOND = 1000;\n        const MS_PER_MINUTE = MS_PER_SECOND * 60;\n        const MS_PER_HOUR = MS_PER_MINUTE * 60;\n        const MS_PER_DAY = MS_PER_HOUR * 24;\n        const MS_PER_WEEK = MS_PER_DAY * 7;\n        \n        switch (unit) {\n            case TemporalUnit.seconds:\n                return amount * MS_PER_SECOND;\n            case TemporalUnit.minutes:\n                return amount * MS_PER_MINUTE;\n            case TemporalUnit.hours:\n                return amount * MS_PER_HOUR;\n            case TemporalUnit.days:\n                return amount * MS_PER_DAY;\n            case TemporalUnit.weeks:\n                return amount * MS_PER_WEEK;\n            default:\n                throw new Error(`Unsupported temporal unit: ${unit}`);\n        }\n    }\n\n    async trigger(data: ITemplateModel, request: ILateDeliveryAndPenaltyRequest, state: ILateDeliveryAndPenaltyState) : Promise<LateDeliveryContractResponse> {\n        // Use deliveredAt if present, otherwise use now()\n        // Using native Date objects for date operations\n        const agreedDelivery = new Date(request.agreedDelivery);\n        const effectiveDelivery = request.deliveredAt ? new Date(request.deliveredAt) : new Date();\n\n        // Early guard: cannot exercise before agreed delivery date\n        if (agreedDelivery.getTime() > effectiveDelivery.getTime()) {\n            throw new Error('Cannot exercise late delivery before delivery date');\n        }\n\n        let penalty = 0.0;\n        let buyerMayTerminate = false;\n\n        // Ergo-style force majeure: only if both contract and request have force majeure\n        if (data.forceMajeure && request.forceMajeure) {\n            // Force majeure applies - no penalty, but buyer may terminate\n            buyerMayTerminate = true;\n        } else {\n            // Calculate the time difference between effective delivery and agreed delivery\n            const delayMs = effectiveDelivery.getTime() - agreedDelivery.getTime();\n            const penaltyDurationMs = this.convertDurationToMilliseconds(data.penaltyDuration);\n            const terminationMs = this.convertDurationToMilliseconds(data.termination);\n\n            // Calculate ratio (can be fractional)\n            const diffRatio = delayMs / penaltyDurationMs;\n\n            // If delivered on time or early, or no positive delay, no penalty\n            if (diffRatio > 0) {\n                // Penalty formula: ratio * penaltyPercentage/100 * goodsValue\n                const penaltyRaw = diffRatio * (data.penaltyPercentage / 100.0) * request.goodsValue;\n                // Cap\n                const maxPenalty = (data.capPercentage / 100.0) * request.goodsValue;\n                penalty = Math.min(penaltyRaw, maxPenalty);\n                // Termination\n                buyerMayTerminate = delayMs > terminationMs;\n            }\n        }\n\n        // Update state: mark late delivery as processed if penalty > 0, and add to running total\n        const newState: ILateDeliveryAndPenaltyState = {\n            $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyState',\n            $identifier: state.$identifier,\n            count: state.count + 1,\n            lateDeliveryProcessed: penalty > 0 || state.lateDeliveryProcessed,\n            totalPenalties: state.totalPenalties + penalty,\n        };\n\n        const event: ILateDeliveryAndPenaltyEvent = {\n            $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyEvent',\n            $timestamp: new Date(),\n            penaltyCalculated: penalty > 0\n        };\n\n        return {\n            result: {\n                penalty: penalty,\n                buyerMayTerminate: buyerMayTerminate,\n                $timestamp: new Date(),\n                $class: 'io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyResponse'\n            },\n            events: [event],\n            state: newState\n        };\n    }\n}\n\nexport default LateDeliveryLogic;\n"
      }
    ],
    "stateType": "io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyState"
  },
  "sampleRequest": "{\n    \"$class\": \"io.clause.latedeliveryandpenalty@0.1.0.LateDeliveryAndPenaltyRequest\",\n    \"forceMajeure\": false,\n    \"agreedDelivery\": \"December 17, 2017 03:24:00\",\n    \"deliveredAt\": null,\n    \"goodsValue\": 200.00\n}\n"
}